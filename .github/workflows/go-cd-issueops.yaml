name: Go - CD IssueOps

on:
  issue_comment:
    types:
      - created
  workflow_call: {}

concurrency:
  group: go-cd-issueops

defaults:
  run:
    shell: bash

jobs:
  dispatch:
    name: Dispatch IssueOps commands
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    outputs:
      continue: ${{ steps.dispatch-issueops-commands.outputs.continue }}
      sha: ${{ steps.dispatch-issueops-commands.outputs.sha }}
      ref: ${{ steps.dispatch-issueops-commands.outputs.ref }}
      base_ref: ${{ steps.dispatch-issueops-commands.outputs.base_ref }}
      actor: ${{ steps.dispatch-issueops-commands.outputs.actor }}
      params: ${{ steps.dispatch-issueops-commands.outputs.params }}
      issue_number: ${{ steps.dispatch-issueops-commands.outputs.issue_number }}
      target_env: ${{ steps.output-target-env.outputs.target_env }}
      deployment_id: ${{ steps.start-deployment.outputs.id }}
    permissions:
      pull-requests: write
      deployments: write
    steps:
      # Checkout is useful for {owner} and {repo} placeholders in gh api command
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
      - name: Receive IssueOps commands
        id: dispatch-issueops-commands
        uses: github/command@v2
        with:
          command: .deploy
          param_separator: ' '
          skip_reviews: true
          skip_ci: true
          permissions: write,admin
          reaction: eyes
          failure_reaction: boom
          success_reaction: rocket
      - name: Output target environment
        id: output-target-env
        run: |
          declare target_env
          target_env="${{ steps.dispatch-issueops-commands.outputs.base_ref == 'main' && 'next' || 'dev' }}"
          if [ -z "${target_env}" ]; then
            echo "Failed to determine target environment, got ${target_env}"
            exit 1
          fi
          echo "target_env=${target_env}" >> "${GITHUB_OUTPUT}"
      - name: Comment deploy start
        id: comment-deploy-start
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: append
          append-separator: newline
          body: |
            <!-- comment-deploy-start -->

            ## Deployment details :rocket:

            Deploying to **[${{ steps.output-target-env.outputs.target_env }}](../deployments/${{ steps.output-target-env.outputs.target_env }})**

            [Workflow run](../actions/runs/${{ github.run_id }})
      - name: Start deployment
        id: start-deployment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          declare ref
          ref="${{ steps.dispatch-issueops-commands.outputs.ref }}"
          if [ -z "${ref}" ]; then
            echo "Failed to determine ref, got ${ref}"
            exit 1
          fi
          echo "ref is ${ref}"
          declare target_env
          target_env="${{ steps.output-target-env.outputs.target_env }}"
          if [ -z "${target_env}" ]; then
            echo "Failed to determine target environment, got ${target_env}"
            exit 1
          fi
          echo "Target environment is ${target_env}"
          declare github_actor
          github_actor="${{ steps.dispatch-issueops-commands.outputs.actor }}"
          if [ -z "${github_actor}" ]; then
            echo "Failed to determine GitHub actor, got ${github_actor}"
            exit 1
          fi
          echo "GitHub actor is ${github_actor}"
          declare repo
          repo="${{ github.repository }}"
          if [ -z "${repo}" ]; then
            echo "Failed to determine repository, got ${repo}"
            exit 1
          fi
          echo "Repository is ${repo}"
          declare pull_request_number
          pull_request_number="${{ steps.dispatch-issueops-commands.outputs.issue_number }}"
          if [ -z "${pull_request_number}" ]; then
            echo "Failed to determine pull request number, got ${pull_request_number}"
            exit 1
          fi
          echo "Pull request number is ${pull_request_number}"
          declare deployment_id
          deployment_id="$(gh api \
            --jq '.id' \
            --method POST \
            repos/{owner}/{repo}/deployments \
            -f ref="${ref}" \
            -f task='deploy' \
            -f required_contexts\[\] \
            -f environment="${target_env}" \
            -f description="Deploy request from IssueOps, initiated by ${github_actor} on ${repo}#${pull_request_number}")"
          if [ -z "${deployment_id}" ]; then
            echo "Failed to start deployment"
            exit 1
          fi
          echo "Deployment started with ID ${deployment_id}"
          echo "deployment_id=${deployment_id}" >> "${GITHUB_OUTPUT}"

  build-code:
    name: Build code
    needs: dispatch
    if: ${{ needs.dispatch.outputs.continue == 'true' }}
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.dispatch.outputs.sha }}
          fetch-depth: 0
      - name: Build code
        id: build
        uses: kemadev/workflows-and-actions/.github/actions/go-build@main

  get-deploys-list:
    name: Get deploys list
    needs:
      - dispatch
      - build-code
    if: ${{ needs.dispatch.outputs.continue == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    outputs:
      deployment-dirs-list: ${{ steps.get-deploys-list.outputs.deployment-dirs-list }}
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.dispatch.outputs.sha }}
          fetch-depth: 0
      - name: Get deploys list
        id: get-deploys-list
        uses: kemadev/workflows-and-actions/.github/actions/go-get-deploys-list@main

  deploy:
    name: Deploy
    needs:
      - dispatch
      - get-deploys-list
    if: ${{ needs.dispatch.outputs.continue == 'true' }}
    permissions:
      contents: read
      packages: read
      pull-requests: write
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}
    strategy:
      matrix:
        deploy: ${{ fromJSON(needs.get-deploys-list.outputs.deployment-dirs-list) }}
      max-parallel: 1
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.dispatch.outputs.sha }}
      - name: Go deploy
        id: go-deploy
        uses: kemadev/workflows-and-actions/.github/actions/go-deploy@main
        with:
          command: ${{ needs.dispatch.outputs.params }}
          environment: ${{ needs.dispatch.outputs.target_env }}

  finish-deployment:
    name: Comment deploy end
    needs:
      - dispatch
      - deploy
    if: ${{ always() && needs.dispatch.outputs.continue == 'true' }}
    permissions:
      pull-requests:  write
    runs-on: ubuntu-latest
    steps:
      # Checkout is useful for {owner} and {repo} placeholders in gh api command
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
      - name: Comment deploy end
        id: finish-deployment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: append
          append-separator: newline
          body: |
            <!-- finish-deployment -->

            Outcome is **${{ needs.deploy.result == 'success' && 'success :white_check_mark:' || 'failure :boom:' }}**
      - name: Set deployment status
        id: set-deployment-status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          declare state
          state="${{ needs.deploy.result == 'success' && 'success' || 'failure' }}"
          if [ -z "${state}" ]; then
            echo "Failed to determine deployment status, got ${state}"
            exit 1
          fi
          echo "Deployment status is ${state}"
          declare deployment_id
          deployment_id="${{ needs.dispatch.outputs.deployment_id }}"
          if [ -z "${deployment_id}" ]; then
            echo "Failed to determine deployment ID, got ${deployment_id}"
            exit 1
          fi
          gh api \
          --method POST \
          repos/{owner}/{repo}/deployments/${deployment_id}/statuses \
          -f state="${state}"
          echo "Deployment status set to ${state} for deployment ID ${deployment_id}"
